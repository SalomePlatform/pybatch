[tox]
# Default environments
env_list =
    lint
    test
    docs

[testenv]
#skip_install = true

[testenv:lint]
description = Check syntax and format issues
extras = lint
use_develop = true
commands =
    ruff check --fix {posargs:.}
    ruff format {posargs:.}

[testenv:type]
description = Check typing
extras =
    type
    paramiko
commands =
    mypy --install-types --non-interactive --strict src

[testenv:test]
description = Run tests and generate coverage report
extras =
    test
    paramiko
allowlist_externals =
    mkdir
commands =
    mkdir -p {envdir}/report
    python3 -m pytest -n auto -q --cache-clear --html={envdir}/report/report_pybatch.html --self-contained-html {posargs}
    python -c 'import pathlib; print("Tests report available under file://\{0\}".format(pathlib.Path(r"{envdir}") / "report" / "report_pybatch.html"))'

[testenv:test-no-paramiko]
description = Run tests without installing paramiko dependency.
extras = test
allowlist_externals =
    mkdir
commands =
    mkdir -p {envdir}/report
    python3 -m pytest -k 'not paramiko' -n auto -q --cache-clear --html={envdir}/report/report_pybatch.html --self-contained-html {posargs}
    python -c 'import pathlib; print("Tests report available under file://\{0\}".format(pathlib.Path(r"{envdir}") / "report" / "report_pybatch.html"))'

[testenv:docs]
description = Generate component documentation using Sphinx
extras = docs
allowlist_externals =
    cp
    sed
install_dir = "build/docs"
pdf_name = "pybatch"
commands =
    # Doc API
    sphinx-build doc/source {[testenv:docs]install_dir}/interface/html -d {[testenv:docs]install_dir}/interface/docs_doctree --color -W --keep-going -n -bhtml

[testenv:distrib]
description = Generate wheels for publication to pip repository.
extras = distrib
commands =
    python3 -m build

[pytest]
testpaths =
    tests
norecursedirs =
    tests/data
    tests/scripts
